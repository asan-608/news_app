// ets/view/Mine.ets

import { UserManager, UserInfo } from 'login';
import { promptAction } from '@kit.ArkUI';

@Component
export default struct Mine {
  @State currentUser: UserInfo | null = null;
  @State isLoggedIn: boolean = false;
  private userManager: UserManager = UserManager.getInstance();
  onLogout: () => void = () => {};

  async aboutToAppear() {
    await this.loadUserInfo();
  }

  async loadUserInfo() {
    try {
      await this.userManager.initPreferences();
      const user = await this.userManager.getCurrentUser();
      this.currentUser = user;
      this.isLoggedIn = user !== null;
    } catch (err) {
      console.error('Failed to load user info:', err);
    }
  }

  async logout() {
    try {
      await this.userManager.logout();
      this.currentUser = null;
      this.isLoggedIn = false;
      promptAction.showToast({
        message: $r('app.string.logout')
      });
      
      // ÈÄÄÂá∫ÁôªÂΩïÂêéË∞ÉÁî®ÂõûË∞ÉÂáΩÊï∞
      setTimeout(() => {
        this.onLogout();
      }, 1000); // Âª∂Ëøü1ÁßíËÆ©Áî®Êà∑ÁúãÂà∞ÈÄÄÂá∫ÊàêÂäüÁöÑÊèêÁ§∫
    } catch (err) {
      console.error('Failed to logout:', err);
    }
  }

  @Builder
  buildFunctionItem(title: string, icon: string, hasBadge: boolean = false) {
    Column() {
      Stack() {
        Text(icon)
          .fontSize('24fp')
        
        if (hasBadge) {
          Text('1')
            .fontSize('10fp')
            .fontColor(Color.White)
            .backgroundColor('#FF4444')
            .borderRadius('8vp')
            .padding({ left: '4vp', right: '4vp', top: '2vp', bottom: '2vp' })
            .position({ x: '16vp', y: '-4vp' })
        }
      }
      .width('32vp')
      .height('32vp')
      .margin({ bottom: '8vp' })
      
      Text(title)
        .fontSize('12fp')
        .fontColor('#333333')
        .textAlign(TextAlign.Center)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .alignItems(HorizontalAlign.Center)
    .width('100%')
    .height('60vp')
  }

  @Builder
  buildMoreFunctionItem(title: string, icon: string, color: string) {
    Column() {
      Text(icon)
        .fontSize('20fp')
        .width('32vp')
        .height('32vp')
        .backgroundColor(color)
        .borderRadius('16vp')
        .textAlign(TextAlign.Center)
        .margin({ bottom: '8vp' })
      
      Text(title)
        .fontSize('10fp')
        .fontColor('#333333')
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .alignItems(HorizontalAlign.Center)
    .width('100%')
    .height('70vp')
  }

  build() {
    Column() {
      if (this.isLoggedIn && this.currentUser) {
        // Â∑≤ÁôªÂΩïÁä∂ÊÄÅ - ÈáçÊñ∞ËÆæËÆ°‰∏∫Á±ª‰ººÂõæÁâáÁöÑÂ∏ÉÂ±Ä
        Column() {
          // È°∂ÈÉ®ÂÆâÂÖ®Âå∫ÂüüÂç†‰Ωç
          Blank()
            .height('40vp')
          // Áî®Êà∑Â§¥ÂÉèÂíåÂü∫Êú¨‰ø°ÊÅØÂå∫Âüü
          Row() {
            // Âè≥‰æßÂäüËÉΩÊåâÈíÆ
            Row() {
              Button() {
                Text('üóì')
                  .fontSize('20fp')
              }
              .backgroundColor(Color.Transparent)
              .margin({ right: '12vp' })
              
              Button() {
                Text('üì∑')
                  .fontSize('20fp')
              }
              .backgroundColor(Color.Transparent)
            }
            .justifyContent(FlexAlign.End)
            .width('100%')
          }
          .width('100%')
          .padding({ top: '20vp', left: '16vp', right: '16vp' })
          .margin({ bottom: '20vp' })

          // Áî®Êà∑‰ø°ÊÅØÂç°Áâá
          Row() {
            // Áî®Êà∑Â§¥ÂÉè
            Image($r('app.media.person_shield'))
              .width('60vp')
              .height('60vp')
              .borderRadius('30vp')
              .margin({ right: '16vp' })
            
            // Áî®Êà∑‰ø°ÊÅØ
            Column() {
              Row() {
                Text(this.currentUser.username)
                  .fontSize('20fp')
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#000000')
                
                Blank()
                
                Text('11')
                  .fontSize('16fp')
                  .fontColor('#FF6B35')
                  .margin({ right: '4vp' })
                
                Text('üí∞')
                  .fontSize('16fp')
              }
              .width('100%')
              .margin({ bottom: '8vp' })
              
              Text('0Ëé∑Ëµû')
                .fontSize('14fp')
                .fontColor('#666666')
                .margin({ bottom: '12vp' })
              
              Row() {
                Text('0ÂèëË°®')
                  .fontSize('14fp')
                  .fontColor('#666666')
                  .margin({ right: '20vp' })
                
                Text('0ÂÖ≥Ê≥®')
                  .fontSize('14fp')
                  .fontColor('#666666')
                  .margin({ right: '20vp' })
                
                Text('0Á≤â‰∏ù')
                  .fontSize('14fp')
                  .fontColor('#666666')
              }
              .width('100%')
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
          .padding({ left: '16vp', right: '16vp' })
          .margin({ bottom: '24vp' })

          // ‰ºöÂëòÂíå‰∏ìÊ†èÂç°Áâá
          Row() {
            // ÊàëÁöÑ‰ºöÂëòÂç°Áâá
            Column() {
              Row() {
                Text('üëë')
                  .fontSize('20fp')
                  .margin({ right: '8vp' })
                
                Text('ÊàëÁöÑ‰ºöÂëò')
                  .fontSize('16fp')
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#000000')
              }
              .justifyContent(FlexAlign.Start)
              .width('100%')
              .margin({ bottom: '8vp' })
              
              Text('È¶ñÊúàÁâπÊÉ†‰ΩéËá≥2Êäò')
                .fontSize('12fp')
                .fontColor('#666666')
                .alignSelf(ItemAlign.Start)
            }
            .layoutWeight(1)
            .padding('16vp')
            .backgroundColor('#FFF8E1')
            .borderRadius('8vp')
            .margin({ right: '8vp' })
            
            // ÊàëÁöÑ‰∏ìÊ†èÂç°Áâá
            Column() {
              Row() {
                Text('üì∞')
                  .fontSize('20fp')
                  .margin({ right: '8vp' })
                
                Text('ÊàëÁöÑ‰∏ìÊ†è')
                  .fontSize('16fp')
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#000000')
              }
              .justifyContent(FlexAlign.Start)
              .width('100%')
              .margin({ bottom: '8vp' })
              
              Text('È¢ÜÂüü‰∏ìÂÆ∂,‰∏ì‰∏öËß£ËØª')
                .fontSize('12fp')
                .fontColor('#666666')
                .alignSelf(ItemAlign.Start)
            }
            .layoutWeight(1)
            .padding('16vp')
            .backgroundColor('#E3F2FD')
            .borderRadius('8vp')
            .margin({ left: '8vp' })
          }
          .width('100%')
          .padding({ left: '16vp', right: '16vp' })
          .margin({ bottom: '24vp' })

          // Â∏∏Áî®ÂäüËÉΩÁΩëÊ†º
          Column() {
            Text('Â∏∏Áî®ÂäüËÉΩ')
              .fontSize('16fp')
              .fontWeight(FontWeight.Medium)
              .fontColor('#000000')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: '16vp' })
            
            Grid() {
              GridItem() {
                this.buildFunctionItem('Ê∂àÊÅØ', 'üí¨', true)
              }
              GridItem() {
                this.buildFunctionItem('Êî∂Ëóè', '‚≠ê')
              }
              GridItem() {
                this.buildFunctionItem('ÂéÜÂè≤', 'üïí')
              }
              GridItem() {
                this.buildFunctionItem('Â∑≤Ëµû', '‚ù§Ô∏è')
              }
              GridItem() {
                this.buildFunctionItem('Á®çÂêéÂê¨', '‚è∞')
              }
              GridItem() {
                this.buildFunctionItem('Â≠ó‰ΩìËÆæÁΩÆ', 'Aa')
              }
              GridItem() {
                this.buildFunctionItem('Â§úÈó¥Ê®°Âºè', 'üåô')
              }
              GridItem() {
                this.buildFunctionItem('‰∏ªÁºñÁ≤æÈÄâ', 'üìù')
              }
              GridItem() {
                this.buildFunctionItem('Â∏ÆÂä©ÂèçÈ¶à', '‚ùì')
              }
              GridItem() {
                this.buildFunctionItem('ÈòÖËØªÂë®Êä•', 'üìä')
              }
              GridItem() {
                this.buildFunctionItem('ÊàëÁöÑ‰∏ãËΩΩ', '‚¨áÔ∏è')
              }
              GridItem() {
                this.buildFunctionItem('ÂÆâÂÖ®‰∏≠ÂøÉ', 'üõ°Ô∏è')
              }
              GridItem() {
                this.buildFunctionItem('Êõ¥Â§öËÆæÁΩÆ', '‚öôÔ∏è')
              }
            }
            .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
            .rowsTemplate('1fr 1fr 1fr')
            .columnsGap('8vp')
            .rowsGap('12vp')
            .backgroundColor(Color.White)
            .borderRadius('16vp')
            .padding('16vp')
            .height('200vp')
          }
          .width('100%')
          .padding({ left: '16vp', right: '16vp' })
          .margin({ bottom: '24vp' })

          // Êõ¥Â§öÂäüËÉΩ
          Column() {
            Text('Êõ¥Â§öÂäüËÉΩ')
              .fontSize('16fp')
              .fontWeight(FontWeight.Medium)
              .fontColor('#000000')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: '16vp' })
            
            Grid() {
              GridItem() {
                this.buildMoreFunctionItem('ËÖæËÆØËßÜÈ¢ë', 'üé¨', '#00C853')
              }
              GridItem() {
                this.buildMoreFunctionItem('ËÖæËÆØ‰ΩìËÇ≤', '‚öΩ', '#FF9800')
              }
              GridItem() {
                this.buildMoreFunctionItem('ÊàëÁöÑËµÑ‰∫ß', 'üí∞', '#E91E63')
              }
              GridItem() {
                this.buildMoreFunctionItem('BonBonÊ∏∏Êàè', 'üéÆ', '#9C27B0')
              }
              GridItem() {
                this.buildMoreFunctionItem('BonBonËØª‰π¶', 'üìö', '#2196F3')
              }
              GridItem() {
                this.buildMoreFunctionItem('Ë¥¢ÂØåÁ≤æÈÄâ', 'üíé', '#FF9800')
              }
              GridItem() {
                this.buildMoreFunctionItem('Êñ∞ÈóªÂ¶π', 'üë©', '#00BCD4')
              }
              GridItem() {
                this.buildMoreFunctionItem('Á≠æÂà∞Á¶èÂà©', 'üéÅ', '#FFD700')
              }
            }
            .columnsTemplate('1fr 1fr 1fr 1fr')
            .rowsTemplate('1fr 1fr')
            .columnsGap('8vp')
            .rowsGap('12vp')
            .backgroundColor(Color.White)
            .borderRadius('16vp')
            .padding('16vp')
            .height('160vp')
          }
          .width('100%')
          .padding({ left: '16vp', right: '16vp' })
          .margin({ bottom: '80vp' }) // ‰∏∫Â∫ïÈÉ®ÂØºËà™ÁïôÁ©∫Èó¥

          // ÂäüËÉΩÊåâÈíÆÂå∫Âüü
          Column({ space: 16 }) {
            // ‰∏™‰∫∫‰ø°ÊÅØÊåâÈíÆ
            Row() {
              Image($r('app.media.account'))
                .width('24vp')
                .height('24vp')
                .margin({ right: '12vp' })
              Text($r('app.string.user_info'))
                .fontSize('16fp')
                .fontColor('#182431')
              Blank()
              Image($r('app.media.right_grey'))
                .width('16vp')
                .height('16vp')
            }
            .width('100%')
            .height('48vp')
            .padding({ left: '16vp', right: '16vp' })
            .backgroundColor('#FFFFFF')
            .borderRadius('8vp')
            .onClick(() => {
              // ÂèØ‰ª•Ê∑ªÂä†ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØÂäüËÉΩ
            })

            // ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
            Row() {
              Image($r('app.media.reset'))
                .width('24vp')
                .height('24vp')
                .margin({ right: '12vp' })
              Text($r('app.string.logout'))
                .fontSize('16fp')
                .fontColor('#E60012')
              Blank()
            }
            .width('100%')
            .height('48vp')
            .padding({ left: '16vp', right: '16vp' })
            .backgroundColor('#FFFFFF')
            .borderRadius('8vp')
            .onClick(() => {
              this.logout();
            })
          }
          .width('100%')
          .padding({ left: '16vp', right: '16vp' })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      } else {
        // Êú™ÁôªÂΩïÁä∂ÊÄÅ
        Column() {
          Image($r('app.media.person_shield'))
            .width('80vp')
            .height('80vp')
            .margin({ top: '100vp', bottom: '20vp' })
          
          Text('ËØ∑ÂÖàÁôªÂΩï')
            .fontSize('18fp')
            .fontWeight(FontWeight.Medium)
            .fontColor('#99182431')
            .margin({ bottom: '40vp' })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}